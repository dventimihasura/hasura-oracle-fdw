# -*- mode: org; -*-

#+STARTUP: indent

* What

This Proof-Of-Concept (POC) project combines [[https://hasura.io/][Hasura]] with [[https://www.postgresql.org/][PostgreSQL]]
and the [[https://github.com/laurenz/oracle_fdw][oracle_fdw]] [[https://www.postgresql.org/docs/current/ddl-foreign-data.html][Foreign Data Wrapper]] in order to access an [[https://www.oracle.com/][Oracle]]
database. 

* Why

The object is to learn more about PostgreSQL Foreign Data Wrappers
(FDW) and how they interact with Harura.

* How

This project has these components:

- [[file:Dockerfile][Dockerfile]] :: Docker build file that creates a Docker image from
  [[https://hub.docker.com/layers/library/postgres/16.0/images/sha256-3648b6c2ac30de803a598afbaaef47851a6ee1795d74b4a5dcc09a22513b15c9][postgres:16]] with the [[https://github.com/laurenz/oracle_fdw][oracle_fdw]] extension installed.  *NOTE*: The
  build process downloads both the PostgreSQL extension and the
  necessary Oracle libraries.  Therefore, internet access is required.
- [[file:docker-compose.yaml][docker-compose.yaml]] :: Docker Compose file that launches three services:
  - oracle :: [[https://www.oracle.com/database/technologies/appdev/xe.html][Oracle XE]] database cluster
  - postgres :: [[https://www.postgresql.org/][PostgreSQL]] database cluster with ~oracle_fdw~ installed
  - graphql-engine :: [[https://hasura.io/][Hasura]] GraphQL Engine with ~postgres~ for both
    its data and its metadata
- [[file:init_oracle/01_chinook.sql][01_chinook.sql]] :: the Chinook database for Oracle
- [[file:init_postgres/01_postgres.sql][01_postgres.sql]] :: SQL script for PostgreSQL that installs the
  ~oracle_fdw~ extension, creates the [[https://www.postgresql.org/docs/current/sql-createserver.html][foreign server]], creates the
  [[https://www.postgresql.org/docs/current/sql-createusermapping.html][user-mapping]], and imports the [[https://www.postgresql.org/docs/current/sql-importforeignschema.html][foreign schema]].
- [[file:metadata][metadata]] :: Hasura metadata directory which configures the GraphQL
  API by tracking the foreign tables and setting up the necessary
  relationships between them

* Steps

** Step 1:  Clone this repository.

#+begin_src bash
  git clone https://github.com/dventimihasura/hasura-oracle-fdw.git
#+end_src

** Step 2:  Navigate to the local repository.

#+begin_src bash
  cd hasura-oracle-fdw
#+end_src

** Step 3:  Create a ~.env~ file.

#+begin_src bash
  cat <<EOF > .env
  HASURA_GRAPHQL_ENDPOINT=<your desired Hasura endpoint>
  HGEPORT=<your exposed port for the Hasura API>
  ORAPORT=<your exposed port for the Oracle DB>
  PGPORT=<your exposed port for the PostgreSQL DB>
  EOF
#+end_src

#+RESULTS:

** Step 4:  Use Docker Compose to launch the services.

#+begin_src bash
  docker-compose up -d
#+end_src

or

#+begin_src bash
  docker compose up -d
#+end_src

** Step 5:  Open Hasura Console

#+begin_src bash
  hasura console
#+end_src

** Step 6:  Test the API

#+begin_src graphql :url http://localhost:8081/v1/graphql
query MyQuery {
  chinook_customer(limit: 1) {
    email
    supportrep {
      firstname
      lastname
      title
    }
    firstname
    lastname
    invoices {
      total
      invoicelines {
        unitprice
        quantity
        track {
          name
          milliseconds
          mediatype {
            name
          }
          genre {
            name
          }
          playlisttracks {
            playlist {
              name
            }
          }
          album {
            title
            artist {
              name
            }
          }
        }
      }
    }
  }
}
#+end_src

#+RESULTS:
#+begin_example
{
  "data": {
    "chinook_customer": [
      {
        "email": "luisg@embraer.com.br",
        "supportrep": {
          "firstname": "Jane",
          "lastname": "Peacock",
          "title": "Sales Support Agent"
        },
        "firstname": "Luís",
        "lastname": "Gonçalves",
        "invoices": [
          {
            "total": 13.86,
            "invoicelines": {
              "unitprice": 0.99,
              "quantity": 1,
              "track": {
                "name": "Já Foi",
                "milliseconds": 245681,
                "mediatype": {
                  "name": "MPEG audio file"
                },
                "genre": {
                  "name": "World"
                },
                "playlisttracks": [
                  {
                    "playlist": {
                      "name": "Music"
                    }
                  },
                  {
                    "playlist": {
                      "name": "Music"
                    }
                  }
                ],
                "album": {
                  "title": "Demorou...",
                  "artist": {
                    "name": "Mônica Marianno"
                  }
                }
              }
            }
          },
          {
            "total": 8.91,
            "invoicelines": {
              "unitprice": 0.99,
              "quantity": 1,
              "track": {
                "name": "Pretty Persuasion",
                "milliseconds": 229929,
                "mediatype": {
                  "name": "MPEG audio file"
                },
                "genre": {
                  "name": "Alternative & Punk"
                },
                "playlisttracks": [
                  {
                    "playlist": {
                      "name": "Music"
                    }
                  },
                  {
                    "playlist": {
                      "name": "Music"
                    }
                  }
                ],
                "album": {
                  "title": "The Best Of R.E.M.: The IRS Years",
                  "artist": {
                    "name": "R.E.M."
                  }
                }
              }
            }
          },
          {
            "total": 3.98,
            "invoicelines": {
              "unitprice": 0.99,
              "quantity": 1,
              "track": {
                "name": "União Da Ilha",
                "milliseconds": 330945,
                "mediatype": {
                  "name": "MPEG audio file"
                },
                "genre": {
                  "name": "Latin"
                },
                "playlisttracks": [
                  {
                    "playlist": {
                      "name": "Music"
                    }
                  },
                  {
                    "playlist": {
                      "name": "Music"
                    }
                  }
                ],
                "album": {
                  "title": "Sambas De Enredo 2001",
                  "artist": {
                    "name": "Various Artists"
                  }
                }
              }
            }
          },
          {
            "total": 3.96,
            "invoicelines": {
              "unitprice": 0.99,
              "quantity": 1,
              "track": {
                "name": "Born To Move",
                "milliseconds": 342804,
                "mediatype": {
                  "name": "MPEG audio file"
                },
                "genre": {
                  "name": "Rock"
                },
                "playlisttracks": [
                  {
                    "playlist": {
                      "name": "Music"
                    }
                  },
                  {
                    "playlist": {
                      "name": "Music"
                    }
                  }
                ],
                "album": {
                  "title": "Chronicle, Vol. 2",
                  "artist": {
                    "name": "Creedence Clearwater Revival"
                  }
                }
              }
            }
          },
          {
            "total": 5.94,
            "invoicelines": {
              "unitprice": 0.99,
              "quantity": 1,
              "track": {
                "name": "Esquinas",
                "milliseconds": 280999,
                "mediatype": {
                  "name": "MPEG audio file"
                },
                "genre": {
                  "name": "Latin"
                },
                "playlisttracks": [
                  {
                    "playlist": {
                      "name": "Music"
                    }
                  },
                  {
                    "playlist": {
                      "name": "Music"
                    }
                  },
                  {
                    "playlist": {
                      "name": "90’s Music"
                    }
                  },
                  {
                    "playlist": {
                      "name": "Brazilian Music"
                    }
                  }
                ],
                "album": {
                  "title": "Djavan Ao Vivo - Vol. 02",
                  "artist": {
                    "name": "Djavan"
                  }
                }
              }
            }
          },
          {
            "total": 0.99,
            "invoicelines": {
              "unitprice": 0.99,
              "quantity": 1,
              "track": {
                "name": "Don't Damn Me",
                "milliseconds": 318901,
                "mediatype": {
                  "name": "Protected AAC audio file"
                },
                "genre": {
                  "name": "Rock"
                },
                "playlisttracks": [
                  {
                    "playlist": {
                      "name": "Music"
                    }
                  },
                  {
                    "playlist": {
                      "name": "Music"
                    }
                  },
                  {
                    "playlist": {
                      "name": "90’s Music"
                    }
                  }
                ],
                "album": {
                  "title": "Use Your Illusion I",
                  "artist": {
                    "name": "Guns N' Roses"
                  }
                }
              }
            }
          },
          {
            "total": 1.98,
            "invoicelines": {
              "unitprice": 0.99,
              "quantity": 1,
              "track": {
                "name": "All Within My Hands",
                "milliseconds": 527986,
                "mediatype": {
                  "name": "MPEG audio file"
                },
                "genre": {
                  "name": "Metal"
                },
                "playlisttracks": [
                  {
                    "playlist": {
                      "name": "Music"
                    }
                  },
                  {
                    "playlist": {
                      "name": "Music"
                    }
                  }
                ],
                "album": {
                  "title": "St. Anger",
                  "artist": {
                    "name": "Metallica"
                  }
                }
              }
            }
          }
        ]
      }
    ]
  }
}
#+end_example
